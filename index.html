<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ALZA STORE</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .page { display: none; }
    .active { display: block; }
    nav button { transition: background 0.2s; }
    nav button:hover { background-color: #2563eb; color: white; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4 text-center">üõçÔ∏è ALZA STORE</h1>

    <!-- Navbar -->
    <nav class="flex justify-center gap-4 mb-6">
      <button onclick="showPage('dashboard')" class="px-4 py-2 bg-blue-500 text-white rounded">Dashboard</button>
      <button onclick="showPage('stok')" class="px-4 py-2 bg-gray-200 rounded">Stok</button>
      <button onclick="showPage('kasir')" class="px-4 py-2 bg-gray-200 rounded">Kasir</button>
      <button onclick="showPage('laporan')" class="px-4 py-2 bg-gray-200 rounded">Laporan</button>
    </nav>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white bg-opacity-90 text-lg hidden">Menghubungkan ke Database...</div>

    <!-- Dashboard -->
    <section id="dashboard" class="page active">
      <h2 class="text-xl font-semibold mb-2">üìä Dashboard Penjualan</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <div class="p-4 bg-white shadow rounded">
          <p>Total Penjualan:</p>
          <p id="totalPenjualan" class="text-xl font-bold">Rp 0</p>
        </div>
        <div class="p-4 bg-white shadow rounded">
          <p>Total Keuntungan:</p>
          <p id="totalKeuntungan" class="text-xl font-bold">Rp 0</p>
        </div>
        <div class="p-4 bg-white shadow rounded">
          <p>Total Produk:</p>
          <p id="totalProduk" class="text-xl font-bold">0</p>
        </div>
      </div>
    </section>

    <!-- Manajemen Stok -->
    <section id="stok" class="page">
      <h2 class="text-xl font-semibold mb-2">üì¶ Manajemen Stok</h2>
      <form id="form-stok" class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-4">
        <input type="hidden" id="stok-id">
        <input type="text" id="stok-nama" placeholder="Nama Produk" class="border p-2 rounded" required>
        <input type="number" id="stok-modal" placeholder="Modal" class="border p-2 rounded" required>
        <input type="number" id="stok-harga" placeholder="Harga Jual" class="border p-2 rounded" required>
        <input type="number" id="stok-jumlah" placeholder="Stok" class="border p-2 rounded" required>
        <button type="submit" class="col-span-1 md:col-span-5 bg-blue-600 text-white py-2 rounded">Simpan</button>
      </form>

      <table class="min-w-full bg-white border rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">Nama</th>
            <th class="p-2">Modal</th>
            <th class="p-2">Harga</th>
            <th class="p-2">Stok</th>
            <th class="p-2">Aksi</th>
          </tr>
        </thead>
        <tbody id="stokTable"></tbody>
      </table>
    </section>

    <!-- Kasir -->
    <section id="kasir" class="page">
      <h2 class="text-xl font-semibold mb-2">üßæ Kasir</h2>
      <form id="form-kasir" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-4">
        <select id="kasir-produk" class="border p-2 rounded" required></select>
        <input type="number" id="kasir-qty" placeholder="Qty" class="border p-2 rounded" required>
        <button type="submit" class="bg-green-600 text-white py-2 rounded col-span-1 md:col-span-2">Proses Transaksi</button>
      </form>

      <table class="min-w-full bg-white border rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">Produk</th>
            <th class="p-2">Qty</th>
            <th class="p-2">Total</th>
            <th class="p-2">Waktu</th>
          </tr>
        </thead>
        <tbody id="kasirTable"></tbody>
      </table>
    </section>

    <!-- Laporan -->
    <section id="laporan" class="page">
      <h2 class="text-xl font-semibold mb-2">üìë Laporan Penjualan</h2>
      <table class="min-w-full bg-white border rounded shadow">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="p-2">Tanggal</th>
            <th class="p-2">Produk</th>
            <th class="p-2">Qty</th>
            <th class="p-2">Total</th>
            <th class="p-2">Keuntungan</th>
          </tr>
        </thead>
        <tbody id="laporanTable"></tbody>
      </table>
    </section>
  </div>

  <script>
    const supabaseUrl = 'https://pmxkyzgsauzxeidbjuhd.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBteGt5emdzYXV6eGVpZGJqdWhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjMwNDAsImV4cCI6MjA3NjY5OTA0MH0.oXlVN7F-CXN6zDCuOOr8u2N6efIo9GWd9JyJ5O0_fyA';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const pages = ['dashboard', 'stok', 'kasir', 'laporan'];
    function showPage(id) {
      pages.forEach(p => document.getElementById(p).classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('loading').classList.remove('hidden');
      await Promise.all([loadDashboard(), loadStok(), loadKasir(), loadLaporan()]);
      document.getElementById('loading').classList.add('hidden');
    });

    // === DASHBOARD ===
    async function loadDashboard() {
      const { data: produk } = await supabase.from('produk').select('*');
      const { data: transaksi } = await supabase.from('transaksi').select('*');
      const totalProduk = produk?.length || 0;
      const totalPenjualan = transaksi?.reduce((sum, t) => sum + t.total, 0) || 0;
      const totalKeuntungan = transaksi?.reduce((sum, t) => sum + t.keuntungan, 0) || 0;
      document.getElementById('totalProduk').textContent = totalProduk;
      document.getElementById('totalPenjualan').textContent = 'Rp ' + totalPenjualan.toLocaleString('id-ID');
      document.getElementById('totalKeuntungan').textContent = 'Rp ' + totalKeuntungan.toLocaleString('id-ID');
    }

    // === STOK ===
    async function loadStok() {
      const { data } = await supabase.from('produk').select('*').order('id', { ascending: false });
      const tbody = document.getElementById('stokTable');
      const selectKasir = document.getElementById('kasir-produk');
      tbody.innerHTML = '';
      selectKasir.innerHTML = '<option value="">Pilih Produk</option>';

      data.forEach(p => {
        tbody.innerHTML += `
          <tr>
            <td class="p-2">${p.nama}</td>
            <td class="p-2">Rp ${p.modal}</td>
            <td class="p-2">Rp ${p.harga_jual}</td>
            <td class="p-2">${p.stok}</td>
            <td class="p-2">
              <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="editStok(${p.id}, '${p.nama}', ${p.modal}, ${p.harga_jual}, ${p.stok})">Edit</button>
              <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="hapusProduk(${p.id})">Hapus</button>
            </td>
          </tr>
        `;
        selectKasir.innerHTML += `<option value="${p.id}">${p.nama}</option>`;
      });
    }

    function editStok(id, nama, modal, harga, stok) {
      document.getElementById('stok-id').value = id;
      document.getElementById('stok-nama').value = nama;
      document.getElementById('stok-modal').value = modal;
      document.getElementById('stok-harga').value = harga;
      document.getElementById('stok-jumlah').value = stok;
    }

    document.getElementById('form-stok').addEventListener('submit', async e => {
      e.preventDefault();
      const id = document.getElementById('stok-id').value;
      const nama = document.getElementById('stok-nama').value;
      const modal = parseFloat(document.getElementById('stok-modal').value);
      const harga_jual = parseFloat(document.getElementById('stok-harga').value);
      const stok = parseInt(document.getElementById('stok-jumlah').value);

      if (id) {
        await supabase.from('produk').update({ nama, modal, harga_jual, stok }).eq('id', id);
      } else {
        await supabase.from('produk').insert([{ nama, modal, harga_jual, stok }]);
      }
      e.target.reset();
      loadStok();
      loadDashboard();
    });

    async function hapusProduk(id) {
      if (confirm('Hapus produk ini?')) {
        await supabase.from('produk').delete().eq('id', id);
        loadStok();
        loadDashboard();
      }
    }

    // === KASIR ===
    document.getElementById('form-kasir').addEventListener('submit', async e => {
      e.preventDefault();
      const produk_id = parseInt(document.getElementById('kasir-produk').value);
      const qty = parseInt(document.getElementById('kasir-qty').value);
      if (!produk_id || qty <= 0) return alert('Lengkapi data!');

      const { error } = await supabase.from('transaksi').insert([{ produk_id, qty }]);
      if (error) alert('Gagal transaksi: ' + error.message);
      e.target.reset();
      loadKasir();
      loadLaporan();
      loadDashboard();
      loadStok();
    });

    async function loadKasir() {
      const { data, error } = await supabase.from('transaksi').select('*, produk(nama)').order('id', { ascending: false });
      if (error) return console.error(error);
      const tbody = document.getElementById('kasirTable');
      tbody.innerHTML = data.map(t => `
        <tr>
          <td class="p-2">${t.produk.nama}</td>
          <td class="p-2">${t.qty}</td>
          <td class="p-2">Rp ${t.total?.toLocaleString('id-ID')}</td>
          <td class="p-2">${new Date(t.created_at).toLocaleString('id-ID')}</td>
        </tr>`).join('');
    }

    // === LAPORAN ===
    async function loadLaporan() {
      const { data, error } = await supabase.from('transaksi').select('*, produk(nama)').order('id', { ascending: false });
      if (error) return console.error(error);
      const tbody = document.getElementById('laporanTable');
      tbody.innerHTML = data.map(t => `
        <tr>
          <td class="p-2">${new Date(t.created_at).toLocaleString('id-ID')}</td>
          <td class="p-2">${t.produk.nama}</td>
          <td class="p-2">${t.qty}</td>
          <td class="p-2">Rp ${t.total?.toLocaleString('id-ID')}</td>
          <td class="p-2">Rp ${t.keuntungan?.toLocaleString('id-ID')}</td>
        </tr>`).join('');
    }
  </script>
</body>
</html>
