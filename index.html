<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ALZA STORE - Fixed</title>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind CDN (simple) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Simple page show/hide */
    .page { display: none; }
    .page.active { display: block; }
    /* Simple nav active style */
    .nav-btn.active { background-color: #1e40af; color: white; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-inter">

  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">üõçÔ∏è ALZA STORE</h1>
      <nav class="flex gap-2">
        <button class="nav-btn px-3 py-1 rounded bg-blue-600 text-white" data-page="dashboard">Dashboard</button>
        <button class="nav-btn px-3 py-1 rounded bg-gray-200" data-page="stok">Stok</button>
        <button class="nav-btn px-3 py-1 rounded bg-gray-200" data-page="kasir">Kasir</button>
        <button class="nav-btn px-3 py-1 rounded bg-gray-200" data-page="laporan">Laporan</button>
      </nav>
    </header>

    <!-- Loading overlay -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-90 text-lg hidden">
      Menghubungkan ke database...
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="page active">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded shadow">
          <p class="text-sm text-gray-500">Total Produk</p>
          <p id="totalProduk" class="text-2xl font-bold">0</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="text-sm text-gray-500">Total Penjualan</p>
          <p id="totalPenjualan" class="text-2xl font-bold">Rp 0</p>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="text-sm text-gray-500">Total Keuntungan</p>
          <p id="totalKeuntungan" class="text-2xl font-bold">Rp 0</p>
        </div>
      </div>
      <div class="mt-6 bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Transaksi Terbaru</h3>
        <div id="dashboardRecent">Memuat...</div>
      </div>
    </section>

    <!-- STOK -->
    <section id="stok" class="page">
      <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="text-lg font-semibold mb-2">Manajemen Stok</h2>
        <form id="formStok" class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <input id="stokId" type="hidden" />
          <input id="stokNama" placeholder="Nama produk" class="border p-2 rounded" required />
          <input id="stokModal" type="number" step="0.01" placeholder="Modal (e.g. 2500)" class="border p-2 rounded" required />
          <input id="stokHarga" type="number" step="0.01" placeholder="Harga Jual (e.g. 4000)" class="border p-2 rounded" required />
          <input id="stokJumlah" type="number" placeholder="Stok" class="border p-2 rounded" required />
          <button class="col-span-1 md:col-span-5 bg-blue-600 text-white py-2 rounded">Simpan</button>
        </form>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Daftar Produk</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 text-left">ID</th>
                <th class="p-2 text-left">Nama</th>
                <th class="p-2 text-left">Modal</th>
                <th class="p-2 text-left">Harga Jual</th>
                <th class="p-2 text-left">Stok</th>
                <th class="p-2 text-left">Aksi</th>
              </tr>
            </thead>
            <tbody id="stokTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- KASIR -->
    <section id="kasir" class="page">
      <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="text-lg font-semibold mb-2">Kasir (POS)</h2>
        <form id="formKasir" class="grid grid-cols-1 md:grid-cols-4 gap-2">
          <select id="kasirProduk" class="border p-2 rounded" required>
            <option value="">-- Pilih Produk --</option>
          </select>
          <input id="kasirQty" type="number" min="1" value="1" class="border p-2 rounded" required />
          <div class="col-span-1 md:col-span-2 flex gap-2">
            <button class="bg-green-600 text-white px-4 py-2 rounded">Proses</button>
            <button id="kasirClear" type="button" class="bg-gray-300 px-4 py-2 rounded">Bersihkan</button>
          </div>
        </form>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold mb-2">Riwayat Transaksi Terbaru</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 text-left">Produk</th>
                <th class="p-2 text-left">Qty</th>
                <th class="p-2 text-left">Total</th>
                <th class="p-2 text-left">Waktu</th>
              </tr>
            </thead>
            <tbody id="kasirTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- LAPORAN -->
    <section id="laporan" class="page">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Laporan Penjualan</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-2 text-left">Tanggal</th>
                <th class="p-2 text-left">Produk</th>
                <th class="p-2 text-left">Qty</th>
                <th class="p-2 text-left">Total</th>
                <th class="p-2 text-left">Keuntungan</th>
              </tr>
            </thead>
            <tbody id="laporanTable"></tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = 'https://pmxkyzgsauzxeidbjuhd.supabase.co'; // ganti
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBteGt5emdzYXV6eGVpZGJqdWhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMjMwNDAsImV4cCI6MjA3NjY5OTA0MH0.oXlVN7F-CXN6zDCuOOr8u2N6efIo9GWd9JyJ5O0_fyA'; // ganti
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM helpers
    const loadingEl = document.getElementById('loading');
    const navButtons = document.querySelectorAll('.nav-btn');

    // Page control
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById(pageId);
      if (el) el.classList.add('active');

      // nav active class
      navButtons.forEach(b => {
        b.classList.toggle('active', b.dataset.page === pageId);
      });
    }

    // wire nav buttons
    navButtons.forEach(btn => {
      const pid = btn.dataset.page;
      btn.addEventListener('click', () => showPage(pid));
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        loadingEl.classList.remove('hidden');
        await Promise.all([refreshAll()]);
        showPage('dashboard');
      } catch (err) {
        console.error('Init error:', err);
        alert('Gagal inisialisasi: lihat console');
      } finally {
        loadingEl.classList.add('hidden');
      }
    });

    // Refresh everything
    async function refreshAll() {
      await Promise.all([loadStok(), loadKasir(), loadLaporan(), loadDashboard() ]);
    }

    // ===========================
    //  LOAD / DASHBOARD
    // ===========================
    async function loadDashboard() {
      try {
        const { data: produk } = await supabase.from('produk').select('*');
        const { data: transaksi } = await supabase.from('transaksi').select('*');

        const totalProduk = produk ? produk.length : 0;
        const totalPenjualan = transaksi ? transaksi.reduce((s, t) => s + Number(t.total || 0), 0) : 0;
        const totalKeuntungan = transaksi ? transaksi.reduce((s, t) => s + Number(t.keuntungan || 0), 0) : 0;

        document.getElementById('totalProduk').textContent = totalProduk;
        document.getElementById('totalPenjualan').textContent = 'Rp ' + totalPenjualan.toLocaleString('id-ID');
        document.getElementById('totalKeuntungan').textContent = 'Rp ' + totalKeuntungan.toLocaleString('id-ID');

        // recent transaksi (show 5)
        const recentEl = document.getElementById('dashboardRecent');
        if (!transaksi || transaksi.length === 0) {
          recentEl.textContent = 'Belum ada transaksi.';
        } else {
          const sorted = [...transaksi].sort((a,b)=> new Date(b.created_at) - new Date(a.created_at)).slice(0,5);
          // fetch produk names for those transactions
          const prodIds = [...new Set(sorted.map(t => t.produk_id))];
          const { data: prods } = await supabase.from('produk').select('id,nama').in('id', prodIds);
          const prodMap = (prods||[]).reduce((m,p)=> (m[p.id]=p.nama, m), {});
          recentEl.innerHTML = '<ul class="list-disc pl-5">' + sorted.map(t => {
            const name = prodMap[t.produk_id] || '‚Äî';
            const total = Number(t.total || 0);
            return `<li>${name} ‚Äî ${t.qty} pcs ‚Äî Rp ${total.toLocaleString('id-ID')} <span class="text-xs text-gray-500">(${new Date(t.created_at).toLocaleString('id-ID')})</span></li>`;
          }).join('') + '</ul>';
        }

      } catch (err) {
        console.error('loadDashboard error', err);
      }
    }

    // ===========================
    //  STOK (CRUD)
    // ===========================
    const stokTable = document.getElementById('stokTable');
    async function loadStok() {
      try {
        const { data, error } = await supabase.from('produk').select('*').order('id', { ascending: false });
        if (error) throw error;
        stokTable.innerHTML = (data || []).map(p => `
          <tr>
            <td class="p-2">${p.id}</td>
            <td class="p-2">${escapeHtml(p.nama)}</td>
            <td class="p-2">Rp ${Number(p.modal || 0).toLocaleString('id-ID')}</td>
            <td class="p-2">Rp ${Number(p.harga_jual || 0).toLocaleString('id-ID')}</td>
            <td class="p-2">${p.stok}</td>
            <td class="p-2">
              <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="prepareEdit(${p.id})">Edit</button>
              <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="hapusProduk(${p.id})">Hapus</button>
            </td>
          </tr>
        `).join('');
        // refresh kasir product list too
        populateKasirProducts(data || []);
      } catch (err) {
        console.error('loadStok error', err);
      }
    }

    // Form submit - add / update product
    document.getElementById('formStok').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      try {
        const id = document.getElementById('stokId').value;
        const nama = document.getElementById('stokNama').value.trim();
        const modal = Number(document.getElementById('stokModal').value) || 0;
        const harga_jual = Number(document.getElementById('stokHarga').value) || 0;
        const stok = parseInt(document.getElementById('stokJumlah').value) || 0;

        if (!nama) return alert('Nama produk wajib diisi');

        if (id) {
          const { error } = await supabase.from('produk').update({ nama, modal, harga_jual, stok }).eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await supabase.from('produk').insert([{ nama, modal, harga_jual, stok }]);
          if (error) throw error;
        }
        ev.target.reset();
        document.getElementById('stokId').value = '';
        await refreshAll();
        showPage('stok');
      } catch (err) {
        console.error('formStok submit error', err);
        alert('Gagal simpan produk: ' + (err.message || err));
      }
    });

    // prepare edit
    window.prepareEdit = async function (id) {
      try {
        const { data, error } = await supabase.from('produk').select('*').eq('id', id).single();
        if (error) throw error;
        document.getElementById('stokId').value = data.id;
        document.getElementById('stokNama').value = data.nama;
        document.getElementById('stokModal').value = data.modal;
        document.getElementById('stokHarga').value = data.harga_jual;
        document.getElementById('stokJumlah').value = data.stok;
        showPage('stok');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) {
        console.error('prepareEdit err', err);
        alert('Gagal ambil data produk');
      }
    };

    // delete product
    window.hapusProduk = async function (id) {
      if (!confirm('Yakin hapus produk ini?')) return;
      try {
        const { error } = await supabase.from('produk').delete().eq('id', id);
        if (error) throw error;
        await refreshAll();
        showPage('stok');
      } catch (err) {
        console.error('hapusProduk err', err);
        alert('Gagal hapus produk');
      }
    };

    // ===========================
    //  KASIR (POS)
    // ===========================
    function populateKasirProducts(products) {
      const sel = document.getElementById('kasirProduk');
      sel.innerHTML = '<option value="">-- Pilih Produk --</option>';
      (products || []).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.nama} ‚Äî Rp ${Number(p.harga_jual||0).toLocaleString('id-ID')} (Stok: ${p.stok})`;
        sel.appendChild(opt);
      });
    }

    document.getElementById('formKasir').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      try {
        const produkId = Number(document.getElementById('kasirProduk').value);
        const qty = parseInt(document.getElementById('kasirQty').value) || 0;
        if (!produkId || qty <= 0) return alert('Lengkapi produk dan jumlah');

        // fetch produk to check stok
        const { data: produk, error: prodErr } = await supabase.from('produk').select('*').eq('id', produkId).single();
        if (prodErr) throw prodErr;
        if (!produk) return alert('Produk tidak ditemukan');
        if (produk.stok < qty) return alert('Stok tidak cukup');

        // Insert transaksi.
        // Trigger on DB (if installed) will calculate total & keuntungan and reduce stok.
        const { error: insertErr } = await supabase.from('transaksi').insert([{ produk_id: produkId, qty }]);
        if (insertErr) throw insertErr;

        // If DB trigger not present, fallback: update stok and calculate total client-side
        // (safe guard) -> but we attempt to update dashboard & lists anyway.
        await refreshAll();
        showPage('kasir');
        document.getElementById('formKasir').reset();
      } catch (err) {
        console.error('kasir submit err', err);
        alert('Gagal proses transaksi: ' + (err.message || err));
      }
    });

    // kasir history
    async function loadKasir() {
      try {
        // select transaksi with product name via foreign key produk_id
        const { data, error } = await supabase
          .from('transaksi')
          .select('id, produk_id, qty, total, created_at, keuntungan, produk:produk_id(nama)')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;
        const tbody = document.getElementById('kasirTable');
        tbody.innerHTML = (data || []).map(t => {
          const name = t.produk?.nama || '‚Äî';
          const total = Number(t.total || 0);
          return `<tr>
            <td class="p-2">${escapeHtml(name)}</td>
            <td class="p-2">${t.qty}</td>
            <td class="p-2">Rp ${total.toLocaleString('id-ID')}</td>
            <td class="p-2">${new Date(t.created_at).toLocaleString('id-ID')}</td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('loadKasir err', err);
      }
    }

    // ===========================
    //  LAPORAN
    // ===========================
    async function loadLaporan() {
      try {
        const { data, error } = await supabase
          .from('transaksi')
          .select('id, produk_id, qty, total, keuntungan, created_at, produk:produk_id(nama)')
          .order('created_at', { ascending: false })
          .limit(200);
        if (error) throw error;
        const tbody = document.getElementById('laporanTable');
        tbody.innerHTML = (data || []).map(t => {
          const name = t.produk?.nama || '‚Äî';
          return `<tr>
            <td class="p-2">${new Date(t.created_at).toLocaleString('id-ID')}</td>
            <td class="p-2">${escapeHtml(name)}</td>
            <td class="p-2">${t.qty}</td>
            <td class="p-2">Rp ${Number(t.total || 0).toLocaleString('id-ID')}</td>
            <td class="p-2">Rp ${Number(t.keuntungan || 0).toLocaleString('id-ID')}</td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('loadLaporan err', err);
      }
    }

    // ===========================
    //  UTIL & REFRESH
    // ===========================
    async function loadStok() {
      // wrapper to call real loader above
      return loadStokInternal();
    }
    async function loadStokInternal() {
      // implemented above already; but call the same function name used earlier
      const { data, error } = await supabase.from('produk').select('*').order('id', { ascending: false });
      if (error) {
        console.error('loadStokInternal error', error);
        return;
      }
      // fill stok table and kasir select
      const tbody = document.getElementById('stokTable');
      const sel = document.getElementById('kasirProduk');
      tbody.innerHTML = (data || []).map(p => `
        <tr>
          <td class="p-2">${p.id}</td>
          <td class="p-2">${escapeHtml(p.nama)}</td>
          <td class="p-2">Rp ${Number(p.modal||0).toLocaleString('id-ID')}</td>
          <td class="p-2">Rp ${Number(p.harga_jual||0).toLocaleString('id-ID')}</td>
          <td class="p-2">${p.stok}</td>
          <td class="p-2">
            <button class="bg-yellow-500 text-white px-2 py-1 rounded" onclick="prepareEdit(${p.id})">Edit</button>
            <button class="bg-red-600 text-white px-2 py-1 rounded" onclick="hapusProduk(${p.id})">Hapus</button>
          </td>
        </tr>
      `).join('');
      // kasir select
      sel.innerHTML = '<option value="">-- Pilih Produk --</option>' + (data || []).map(p => `<option value="${p.id}">${escapeHtml(p.nama)} ‚Äî Rp ${Number(p.harga_jual||0).toLocaleString('id-ID')} (Stok: ${p.stok})</option>`).join('');
      // also update dashboard and kasir/laporan
      await Promise.all([loadDashboard(), loadKasir(), loadLaporan()]);
    }

    // entrypoint alias used above
    window.prepareEdit = prepareEdit;
    window.hapusProduk = hapusProduk;

    async function loadKasir() { return loadKasirInternal(); }
    async function loadKasirInternal() {
      try {
        const { data, error } = await supabase
          .from('transaksi')
          .select('id, produk_id, qty, total, created_at, produk:produk_id(nama)')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;
        const tbody = document.getElementById('kasirTable');
        tbody.innerHTML = (data || []).map(t => {
          const name = t.produk?.nama || '‚Äî';
          return `<tr>
            <td class="p-2">${escapeHtml(name)}</td>
            <td class="p-2">${t.qty}</td>
            <td class="p-2">Rp ${Number(t.total || 0).toLocaleString('id-ID')}</td>
            <td class="p-2">${new Date(t.created_at).toLocaleString('id-ID')}</td>
          </tr>`;
        }).join('');
      } catch (err) {
        console.error('loadKasirInternal err', err);
      }
    }

    async function loadLaporanInternal() {
      return loadLaporan();
    }

    async function refreshAll() {
      await Promise.all([loadStokInternal(), loadKasirInternal(), loadLaporan()]);
      await loadDashboard();
    }

    // small utility to escape html
    function escapeHtml(text) {
      if (text == null) return '';
      return String(text)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // kasir clear button
    document.getElementById('kasirClear').addEventListener('click', () => {
      document.getElementById('formKasir').reset();
    });

    // End script
  </script>
</body>
</html>
